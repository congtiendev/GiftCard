Bảng giftcard_code:

Trường giftcard_id, code, balance, và amount_used trong bảng này có thể được sử dụng để theo dõi thông tin về từng gift card và số tiền còn lại cũng như lượng tiền đã sử dụng.
Khi một gift card được redeem, bạn cần cập nhật giá trị amount_used tương ứng.


Bảng giftcard_history:

Bảng này có thể được sử dụng để lưu trữ lịch sử các giao dịch liên quan đến gift card.
Trường giftcard_id tham chiếu đến bảng giftcard_code để liên kết với gift card cụ thể.
Trường customer_id tham chiếu đến customer_entity để biết khách hàng nào đã thực hiện giao dịch.
Trường amount ghi lại số tiền đã thay đổi trong giao dịch (dương nếu giao dịch là nạp tiền, âm nếu giao dịch là sử dụng).
Trường action ghi lại hành động thay đổi, có thể là "create" (tạo mới), "redeem" (đã sử dụng), "Used for order" (sử dụng cho đơn đặt hàng), hoặc các hành động tương tự.
Trường action_time ghi lại thời gian diễn ra giao dịch.


Cột giftcard_balance trong bảng customer_entity:

Cột này có thể được sử dụng để lưu trữ tổng giá trị của tất cả gift card đã được redeem bởi khách hàng tương ứng.
Khi có một giao dịch mới liên quan đến gift card, cập nhật giá trị cột giftcard_balance tương ứng trong bảng customer_entity.


Khi một khách hàng sử dụng một gift card có giá trị $100 để thanh toán cho một đơn hàng có tổng giá trị là $20, một số sự kiện sẽ xảy ra trong hệ thống của bạn dựa trên cơ sở dữ liệu và quy trình quản lý gift card mà bạn đã mô tả:

Bảng giftcard_code:

Giá trị amount_used của gift card sẽ được cập nhật từ 0 lên $20 (vì khách hàng đã sử dụng $20 từ tổng giá trị của gift card).
Giá trị balance của customer_entity sẽ trừ đi $20 (vì khách hàng đã sử dụng $20 từ tổng giá trị của gift card). Còn
balance của giftcard_code sẽ không thay đổi.


Bảng giftcard_history:

Một bản ghi mới sẽ được thêm vào bảng này với thông tin về việc sử dụng gift card cho đơn hàng. Trường amount sẽ là -$20 (do sử dụng) và action có thể là "redeem" hoặc "Used for order" (tùy theo thiết kế của bạn).
Cột giftcard_balance trong bảng customer_entity:

Giá trị giftcard_balance của khách hàng sẽ được cập nhật từ $0 lên $20 (vì khách hàng đã sử dụng gift card).
Tóm lại, việc sử dụng một gift card $100 cho một đơn hàng $20 sẽ dẫn đến việc giảm giá trị của gift card
và cập nhật thông tin trong bảng gift card, lịch sử giao dịch,và cột giftcard_balance của khách hàng.
Điều này cho phép bạn theo dõi lịch sử sử dụng và còn lại trên gift card cũng như tổng số tiền khách hàng đã sử dụng từ các gift card.

Amount (Amount used) mà tăng = giá trị của Balance thì giftcard sẽ hết giá trị sử dụng


------------------------------------------------------------------------------------------------------------------------

Buy Gift Card :

- Khi tạo sản phẩm sẽ có mục Gift Card Amount - Đây chính là Balance (Giá trị của GiftCard )
- Khi mua hàng sẽ check xem product_type có phải là virtual hay không, nếu có thì thực hiện :
+ Tiếp tục check xem có giftcard_amount không, nếu có thì tiếp tục thực hiện :
+ Thêm thông tin sản phẩm vừa mua vào bảng giftcard_code với balance là attribute Gift Card Amount (Attribute này được
    lấy qua product_id )
+ Thêm thông tin vào bảng giftcard_history với action là create và amount là giá trị của balance
+ Giá trị của balance trong customer_entity sẽ không thay đổi vì nó chỉ được tăng lên khi người dùng sử dụng redeem


- Khi người dùng redeem giftcard có action là create thì balance sẽ được cộng thêm vào giá trị của balance trong
    customer_entity và thêm thông tin vào bảng giftcard_history với action là redeem và amount là giá trị của balance.

- Khi người dùng sử dụng giftcard để thanh toán cho đơn hàng thì balance (customer_entity) sẽ được trừ đi giá trị của
đơn hàng.
- amount_used trong bảng giftcard_code sẽ được cập nhật lên giá trị của đơn hàng.

=> Thêm thông tin vào bảng giftcard_history với action là Used for order và amount là giá trị của đơn hàng.



Redeem Gift Card : Lưu lại giá trị của giftcard

- Khi người dùng nhập mã redeem sẽ tiến hành kiểm tra các trường hợp với :
    + Mã redeem không tồn tại
    + Mã redeem đã được sử dụng (action = redeem) với customer_id tương ứng
    + Mã redeem đã hết giá trị sử dụng (amount_used = balance)

- Nếu không có trường hợp nào xảy ra thì tiến hành thêm thông tin vào bảng giftcard_history với action là redeem và
    amount là giá trị của balance.
- Cộng giá trị của balance vào giá trị của balance trong customer_entity.



Buy Gift Card :

Khi tạo sản phẩm, có trường "Gift Card Amount" để xác định giá trị của Gift Card (Balance).
Khi mua hàng, kiểm tra nếu sản phẩm có loại "virtual" => Nếu có, kiểm tra giá trị "Gift Card Amount" có tồn tại không.
Nếu có, thực hiện:
Thêm thông tin sản phẩm vào bảng "giftcard_code" với giá trị "balance" là giá trị Gift Card Amount (lấy từ product_id).
Thêm thông tin vào bảng "giftcard_history" với action = "create" và giá trị "amount" là giá trị của balance.
Giá trị của balance trong bảng "customer_entity" sẽ không thay đổi vì nó chỉ được tăng lên khi người dùng sử dụng redeem.


Sử dụng Gift Card để thanh toán đơn hàng (Chưa redeem):

Khi khách hàng sử dụng Gift Card để thanh toán đơn hàng:
    Kiểm tra xem giftcard có tồn tại không và kiểm tra giá trị của nó ( balance = amount_used thì hết giá trị sử dụng).

    Lượng tiền được giam của giftcard = giá trị của đơn hàng.
    VD : Gift Card có giá trị là 100$ và đơn hàng có giá trị là 20$ thì giá trị của đơn hàng giảm đi 20$ và giá trị của
    giftcard còn lại là 80$. ( tăng amount_used lên 20$)

    VD: Gift Card có giá trị là 100$ và đơn hàng có giá trị là 120$ thì giá trị của đơn hàng giảm đi 100$ và giá trị của
    giftcard còn lại là 0$. ( tăng amount_used lên 100$) => hết giá trị sử dụng.

    Tăng giá trị của trường "amount_used" trong bảng "giftcard_code" lên giá trị của đơn hàng.
    Thêm thông tin vào bảng "giftcard_history" với hành động "Used for order" và giá trị "amount" = "amount_used"


Sử dụng Gift Card (Redeem):

Khách hàng sử dụng Gift Card mà đã được Redeem:
    Kiểm tra xem giftcard có tồn tại không và kiểm tra giá trị của nó ( balance = amount_used thì hết giá trị sử dụng).
    Nếu còn giá trị sử dụng thì thực hiện:
    Tăng giá trị của trường "amount_used" trong bảng "giftcard_code" lên giá trị của đơn hàng.
    Thêm thông tin vào bảng "giftcard_history" với hành động "Used for order" và giá trị "amount" = "amount_used"
    Trừ giá trị của balance trong bảng "customer_entity" đi giá trị của đơn hàng















